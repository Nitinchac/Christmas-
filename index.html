<html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Christmas Eve Surprise</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(circle at top, #0b1d3a, #020617);
      color: #fff;
      touch-action: none;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      touch-action: none;
    }

    #message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.4rem;
      text-align: center;
      opacity: 0.95;
      transition: opacity 1s ease;
      pointer-events: none;
      z-index: 10;
    }

    #hint {
      display: block;
      margin-top: 10px;
      font-size: 0.9rem;
      opacity: 0.7;
    }

    #motionBtn {
      position: absolute;
      top: calc(50% + 90px);
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 20px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
      backdrop-filter: blur(6px);
      z-index: 10;
      cursor: pointer;
    }

    #revealText {
      position: absolute;
      bottom: 8%;
      width: 100%;
      text-align: center;
      font-size: 1.1rem;
      opacity: 0;
      transition: opacity 1s ease;
      pointer-events: none;
      z-index: 10;
    }
  </style>
</head>

<body>
  <canvas id="sky"></canvas>
  <canvas id="snow"></canvas>
  <canvas id="image"></canvas>
  <canvas id="frost"></canvas>

  <div id="message">
    Christmas is almost here âœ¨
    <span id="hint">Shake your phone</span>
  </div>

  <button id="motionBtn">Tap to allow magic âœ¨</button>
  <div id="revealText">Rub the frost to reveal your surprise</div>

  <script>
    const sky = document.getElementById('sky');
    const snow = document.getElementById('snow');
    const imageCanvas = document.getElementById('image');
    const frost = document.getElementById('frost');

    const ctxSky = sky.getContext('2d');
    const ctxSnow = snow.getContext('2d');
    const ctxImage = imageCanvas.getContext('2d');
    const ctxFrost = frost.getContext('2d');

    const message = document.getElementById('message');
    const revealText = document.getElementById('revealText');
    const motionBtn = document.getElementById('motionBtn');

    let loadedImage = null;

    function resize() {
      [sky, snow, imageCanvas, frost].forEach(c => {
        c.width = window.innerWidth;
        c.height = window.innerHeight;
      });
      drawStars();
      
      // Redraw image if it's already loaded
      if (loadedImage) {
        drawImageToCanvas();
        // Redraw frost if it was shown
        if (frostTriggered) {
          ctxFrost.fillStyle = '#ffffff';
          ctxFrost.fillRect(0, 0, frost.width, frost.height);
        }
      }
    }
    window.addEventListener('resize', resize);

    function drawStars() {
      ctxSky.clearRect(0, 0, sky.width, sky.height);
      for (let i = 0; i < 120; i++) {
        ctxSky.beginPath();
        ctxSky.arc(
          Math.random() * sky.width,
          Math.random() * sky.height,
          Math.random() * 1.5 + 0.5,
          0,
          Math.PI * 2
        );
        ctxSky.fillStyle = 'rgba(255,255,255,0.8)';
        ctxSky.fill();
      }
    }

    // Snow
    let snowflakes = [];
    let snowStartTime = null;
    let frostTriggered = false;

    function addSnow(n) {
      for (let i = 0; i < n; i++) {
        snowflakes.push({
          x: Math.random() * snow.width,
          y: Math.random() * snow.height,
          r: Math.random() * 3 + 1,
          vy: Math.random() * 1 + 0.6
        });
      }
    }

    function updateSnow(t) {
      ctxSnow.clearRect(0, 0, snow.width, snow.height);

      if (snowflakes.length && !snowStartTime) snowStartTime = t;

      snowflakes.forEach(f => {
        f.y += f.vy;
        if (f.y > snow.height) f.y = -5;
        ctxSnow.beginPath();
        ctxSnow.arc(f.x, f.y, f.r, 0, Math.PI * 2);
        ctxSnow.fillStyle = 'rgba(255,255,255,0.9)';
        ctxSnow.fill();
      });

      if (snowStartTime && !frostTriggered && t - snowStartTime > 5000) {
        frostTriggered = true;
        showFrost();
      }

      requestAnimationFrame(updateSnow);
    }

    // Motion
    function handleShake(e) {
      const a = e.accelerationIncludingGravity;
      if (!a) return;
      const force = Math.abs(a.x) + Math.abs(a.y) + Math.abs(a.z);
      if (force > 22) {
        addSnow(20);
        const currentOpacity = parseFloat(message.style.opacity || 0.95);
        message.style.opacity = Math.max(0, currentOpacity - 0.05);
      }
    }

    function enableMotion() {
      if (typeof DeviceMotionEvent?.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(r => {
          if (r === 'granted') {
            window.addEventListener('devicemotion', handleShake);
            motionBtn.style.display = 'none';
          }
        }).catch(err => {
          console.error('Motion permission error:', err);
          motionBtn.textContent = 'Permission denied';
        });
      } else {
        window.addEventListener('devicemotion', handleShake);
        motionBtn.style.display = 'none';
      }
    }
    motionBtn.addEventListener('click', enableMotion);

    // Draw image to canvas - MAINTAINING ORIGINAL ASPECT RATIO
    function drawImageToCanvas() {
      if (!loadedImage) return;
      
      // Calculate scale to fit image within canvas while maintaining aspect ratio
      const scaleX = imageCanvas.width / loadedImage.width;
      const scaleY = imageCanvas.height / loadedImage.height;
      const scale = Math.min(scaleX, scaleY); // Use min instead of max to fit within bounds
      
      // Calculate dimensions
      const scaledWidth = loadedImage.width * scale;
      const scaledHeight = loadedImage.height * scale;
      
      // Center the image
      const x = (imageCanvas.width - scaledWidth) / 2;
      const y = (imageCanvas.height - scaledHeight) / 2;
      
      ctxImage.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
      ctxImage.drawImage(loadedImage, x, y, scaledWidth, scaledHeight);
    }

    // Frost + image (separate layers)
    function showFrost() {
      const img = new Image();
      // Add cache buster to force reload
      img.src = 'gift.jpg?' + new Date().getTime();
      
      img.onload = () => {
        console.log('Image loaded successfully!');
        loadedImage = img;
        drawImageToCanvas();

        // Draw white frost layer on top
        ctxFrost.fillStyle = '#ffffff';
        ctxFrost.fillRect(0, 0, frost.width, frost.height);

        revealText.style.opacity = 1;
      };
      
      img.onerror = (e) => {
        console.error('Failed to load gift.jpg', e);
        
        // Fallback: show a nice message
        ctxImage.fillStyle = '#ffffff';
        ctxImage.font = 'bold 28px sans-serif';
        ctxImage.textAlign = 'center';
        ctxImage.fillText('ðŸŽ', imageCanvas.width / 2, imageCanvas.height / 2 - 40);
        ctxImage.font = '20px sans-serif';
        ctxImage.fillText('Your Special Gift', imageCanvas.width / 2, imageCanvas.height / 2 + 20);
        ctxImage.fillText('Awaits You!', imageCanvas.width / 2, imageCanvas.height / 2 + 50);
        
        // Still show frost
        ctxFrost.fillStyle = '#ffffff';
        ctxFrost.fillRect(0, 0, frost.width, frost.height);
        revealText.style.opacity = 1;
      };
    }

    // Scratching functionality
    let scratching = false;
    
    function scratch(x, y) {
      ctxFrost.globalCompositeOperation = 'destination-out';
      ctxFrost.beginPath();
      ctxFrost.arc(x, y, 40, 0, Math.PI * 2);
      ctxFrost.fill();
      ctxFrost.globalCompositeOperation = 'source-over';
    }

    // Mouse/touch events for scratching
    frost.addEventListener('pointerdown', (e) => {
      scratching = true;
      scratch(e.clientX, e.clientY);
    });
    
    frost.addEventListener('pointerup', () => {
      scratching = false;
    });
    
    frost.addEventListener('pointercancel', () => {
      scratching = false;
    });
    
    frost.addEventListener('pointermove', (e) => {
      if (scratching) {
        e.preventDefault();
        scratch(e.clientX, e.clientY);
      }
    });
    
    // Prevent scrolling while scratching
    frost.addEventListener('touchmove', (e) => {
      if (scratching) {
        e.preventDefault();
      }
    }, { passive: false });

    // Initialize
    resize();
    updateSnow();
  </script>
</body>
